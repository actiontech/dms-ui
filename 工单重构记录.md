# 工单重构记录

由于需求迭代原因，导致工单页面部分组件逻辑非常混乱，维护困难，所以产生了代码重构的需求。

## 页面变更

### 列表
无变动

### 创建工单

#### 缺陷修复

1. 创建工单时，切换选择的数据源时，在已选择了数据库的情况下，不会清空选择数据库

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/cc774346-c6c6-4ec7-8e87-225dad25cbc5)

预期：![image](https://github.com/actiontech/dms-ui/assets/42765421/cc1ae6b5-3241-4257-9f31-9fc5c3d56a49)

2. 创建工单时，切换选择的数据源时，在网络较差的情况下，对应的数据库数据依旧会显示上一个数据源的数据，而不是 Loading 效果

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/d4e8fd57-3c2f-4a32-8653-466b1a6ae854)

预期：![image](https://github.com/actiontech/dms-ui/assets/42765421/bbfd304b-54a3-4bb6-9bba-aefe34153cc8)

3. 在编辑工单信息时，选择不同类型的数据源不会自动切换到不同 sql 模式下

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/3710f1e0-169f-4b10-bd78-9c84fd58f20b)

预期：![image](https://github.com/actiontech/dms-ui/assets/42765421/de5b54e6-2078-4ee5-97d9-671f1dc09e21)


#### 优化

1. 当审核工单后未提交便离开页面的情况下，给出提示。对应 issue：https://github.com/actiontech/sqle/issues/2162

![image](https://github.com/actiontech/dms-ui/assets/42765421/3eeb4bba-3385-4c75-aa0a-7cad2216b7c1)

2. 数据源对应的规则模板的跳转方式调整为新开页面。 对应 issue：https://github.com/actiontech/sqle/issues/2121

![image](https://github.com/actiontech/dms-ui/assets/42765421/d4ac9791-1e8d-40e7-ba3d-3a4ea690005a)

3. 创建工单时的数据源名称显示优化。对应 issue：https://github.com/actiontech/sqle/issues/2129

![image](https://github.com/actiontech/dms-ui/assets/42765421/bdab6dd2-0068-4add-bca3-24f19e8f54d1)

#### 页面调整

1. 选择文件上线模式表单样式调整。 理由：再多数据源不同SQL模式下，文件模式选择上线字段对应的应该是某一个数据源下，现有的样式感觉像是单独的一个模式。

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/100c1ffb-b5dd-4d8b-af85-8a77f675f3f2)

调整后：![image](https://github.com/actiontech/dms-ui/assets/42765421/7214b685-e022-4676-aa2c-f0cb4e68cc1b)

其他建议优化：感觉现在这个功能隐藏的有点太深了，是否考虑在界面加些提示告知用户这个功能。例如哪些数据源支持，以及sql上传模式得选择 sql文件上传方式或者 zip 文件上传方式。

2. 建议优化：多数据源不同SQL模式下sql上传方式的展示方式
目前采用的是通过 tab 来切换不同数据源对应的 sql 上传方式，当点击审核后会一起对所有数据源一起审核。这里存在一个问题是由于对每个数据源的审核都会发送一次接口，所以可能会出现部分成功、部分数据源失败的情况。这个问题在 v2 to v3 时同步过，但当时并没有提供解决方案
建议将 tab 展示方式调整为页面直接展示出每一个数据源对应的 sql 上传方式，每一块对应一个 审核 按钮。当所有数据源对应的信息都审核完成后，才能跳转至审核结果页面。（待细节优化以及编辑工单信息时是否需要对应的调整）

### 工单详情

#### 优化
1. 驳回工单信息展示优化

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/4df19fbd-a494-42aa-97b3-100d6abc5330)

调整后：![image](https://github.com/actiontech/dms-ui/assets/42765421/99b3ceed-01bc-42d0-8f48-5c88018714d5)

2. 工单详情信息出现以及隐藏时添加动画效果
对应界面：![image](https://github.com/actiontech/dms-ui/assets/42765421/b8566bff-aa37-4e5b-ba39-b26559b565a4)

3. 驳回工单后修改 sql 信息限制sql上传方式为创建时的方式有隐藏改为禁用

现状：![image](https://github.com/actiontech/dms-ui/assets/42765421/584f7852-d018-453d-852f-f3369561caae)

调整后：![image](https://github.com/actiontech/dms-ui/assets/42765421/cf8e45c8-4b2e-460f-9557-f62d3a755904)

4. 驳回工单后修改sql信息后进行了审核且审核成功但未提交离开页面时给出提示

![image](https://github.com/actiontech/dms-ui/assets/42765421/02fc0a57-f4b0-4bea-bdfb-d2549b143f8c)

