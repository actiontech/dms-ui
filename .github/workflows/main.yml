name: CI

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  pull_request:
    branches: [main, 'main-ee', release*, 'temporary/**']
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  checker:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Install dependencies
        uses: ./catch-and-install-pnpm.yml
      - name: Code lint checker
        run: pnpm checker

  test-ee:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    strategy:
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Install dependencies
        uses: ./catch-and-install-pnpm.yml
      - name: Coverage test report ee
        with:
          skip-step: install
          test-script: pnpm test:ci-ee ${{ matrix.shard }} ${{ strategy.job-total }}
          package-manager: pnpm

  test-ce:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Install dependencies
        uses: ./catch-and-install-pnpm.yml
      - name: Coverage test report ce
        with:
          skip-step: install
          test-script: pnpm test:ci-ce
          package-manager: pnpm

  report:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Install dependencies
        uses: ArtiomTr/jest-coverage-report-action@v2
      - name: Coverage test report
        with:
          skip-step: install
          github-token: ${{ secrets.GITHUB_TOKEN }}
          test-script: node ./scripts/jest/merge-report-json.js
          package-manager: pnpm
