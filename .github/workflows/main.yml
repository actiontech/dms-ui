name: CI

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  pull_request:
    branches: [main, 'main-ee', release*, 'temporary/**']
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  checker:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/catch-install-pnpm
      - name: Code lint checker
        run: pnpm checker

  test-ee:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    strategy:
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/catch-install-pnpm
      - name: Coverage test report ee
        run: sh ./scripts/jest/run-ci-ee.sh ${{ matrix.shard }} ${{ strategy.job-total }}

  test-ce:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/catch-install-pnpm
      - name: Coverage test report ce
        run: sh ./scripts/jest/run-ce-ce.sh

  report:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    needs: [test-ee, test-ce]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/catch-install-pnpm
      - name: Coverage test report
        uses: ArtiomTr/jest-coverage-report-action@v2
        with:
          skip-step: install
          github-token: ${{ secrets.GITHUB_TOKEN }}
          test-script: node ./scripts/jest/merge-report-json.js
          package-manager: pnpm
